{
  "session_id": "cc384e8d-b3e8-4b47-8edf-372271e71a3f",
  "transcript_path": "/home/sam/.claude/projects/-media-sam-1TB-UTXOracle/cc384e8d-b3e8-4b47-8edf-372271e71a3f.jsonl",
  "hook_event_name": "PreToolUse",
  "tool_name": "Write",
  "tool_input": {
    "file_path": "/media/sam/1TB/UTXOracle/test_websocket_fix.py",
    "content": "#!/usr/bin/env python3\n\"\"\"\nTest script to verify WebSocket client registration bug is fixed.\n\nThis script:\n1. Connects a WebSocket client\n2. Waits for data\n3. Verifies that broadcasts reach the client\n\"\"\"\n\nimport asyncio\nimport websockets\nimport json\nimport time\n\n\nasync def test_websocket():\n    uri = \"ws://127.0.0.1:8000/ws/mempool\"\n\n    print(f\"Connecting to {uri}...\")\n    try:\n        async with websockets.connect(uri) as websocket:\n            print(\"✓ Connected successfully\")\n\n            # Wait for first message (timeout 10 seconds)\n            print(\"Waiting for first broadcast (timeout: 10s)...\")\n            try:\n                message = await asyncio.wait_for(websocket.recv(), timeout=10.0)\n                print(f\"✓ Received message!\")\n\n                # Parse and display\n                data = json.loads(message)\n                print(f\"\\nMessage type: {data['type']}\")\n                print(f\"Price: ${data['data']['price']:,.2f}\")\n                print(f\"Confidence: {data['data']['confidence']:.2%}\")\n                print(f\"Active transactions: {data['data']['stats']['active_in_window']}\")\n                print(f\"Total received: {data['data']['stats']['total_received']}\")\n                print(f\"Total filtered: {data['data']['stats']['total_filtered']}\")\n\n                print(\"\\n✓ BUG FIXED: WebSocket client received broadcast!\")\n                return True\n\n            except asyncio.TimeoutError:\n                print(\"✗ TIMEOUT: No message received in 10 seconds\")\n                print(\"✗ BUG STILL PRESENT: Orchestrator not broadcasting to WebSocket clients\")\n                return False\n\n    except Exception as e:\n        print(f\"✗ Connection failed: {e}\")\n        return False\n\n\nif __name__ == \"__main__\":\n    result = asyncio.run(test_websocket())\n    exit(0 if result else 1)\n"
  }
}