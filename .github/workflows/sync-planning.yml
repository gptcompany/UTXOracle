name: Sync Planning
on:
  push:
    paths:
      - '.planning/**'
      - 'tasks.md'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download and run sync
        env:
          # Use PAT if available (can create projects), fallback to GITHUB_TOKEN (issues only)
          GH_TOKEN: ${{ secrets.GH_PROJECT_PAT || secrets.GITHUB_TOKEN }}
          HAS_PAT: ${{ secrets.GH_PROJECT_PAT && 'true' || 'false' }}
        run: |
          curl -sL https://raw.githubusercontent.com/gptcompany/claude-config/main/scripts/github_sync_core.py -o github_sync_core.py
          curl -sL https://raw.githubusercontent.com/gptcompany/claude-config/main/scripts/roadmaptoissues.py -o roadmaptoissues.py

          if [ -f .planning/ROADMAP.md ]; then
            if [ "$HAS_PAT" = "true" ]; then
              # PAT available: can create projects
              python roadmaptoissues.py --roadmap .planning/ROADMAP.md --auto-project --create-project
            else
              # GITHUB_TOKEN: link to existing project only
              python roadmaptoissues.py --roadmap .planning/ROADMAP.md --auto-project
            fi
          else
            echo "No .planning/ROADMAP.md found"
          fi
