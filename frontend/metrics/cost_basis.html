<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Basis | UTXOracle Metrics</title>
    <meta name="description" content="STH/LTH Cost Basis - Compare short-term and long-term holder acquisition prices with market price">
    <link rel="stylesheet" href="../css/metrics.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <div class="metrics-page">
        <header class="metrics-header">
            <h1><span class="btc-icon">&#8383;</span> Cost Basis Analysis</h1>
            <div id="last-updated"></div>
        </header>

        <nav class="metrics-nav">
            <a href="mvrv.html">MVRV</a>
            <a href="nupl.html">NUPL</a>
            <a href="sopr.html">SOPR</a>
            <a href="cost_basis.html" class="active">Cost Basis</a>
            <a href="hash_ribbons.html">Hash Ribbons</a>
            <a href="binary_cdd.html">Binary CDD</a>
            <a href="wallet_waves.html">Wallet Waves</a>
            <a href="exchange_netflow.html">Exchange Netflow</a>
        </nav>

        <div id="info-boxes" class="info-boxes"></div>

        <div id="chart" class="chart-container"></div>

        <section class="legend-section">
            <h3>Cost Basis Lines</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #f7931a;"></div>
                    <span>Market Price - Current BTC price</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff8844;"></div>
                    <span>STH Cost Basis - Short-term holder avg cost</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8844ff;"></div>
                    <span>LTH Cost Basis - Long-term holder avg cost</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff88;"></div>
                    <span>Realized Price - Network avg cost</span>
                </div>
            </div>
        </section>

        <footer class="metrics-footer">
            <p>Data from UTXOracle API | Visual comparison: <a href="https://charts.checkonchain.com/btconchain/realised/realised_price/realised_price_light.html" target="_blank">CheckOnChain Realized Price</a></p>
        </footer>
    </div>

    <script src="../js/chart-themes.js"></script>
    <script src="../js/metrics-common.js"></script>
    <script>
        (async function() {
            const chartId = 'chart';
            const infoId = 'info-boxes';

            MetricsCommon.showLoading(chartId);

            try {
                // Fetch current cost basis data
                const currentData = await MetricsCommon.fetchData('/api/metrics/cost-basis');

                if (!currentData) {
                    MetricsCommon.showNoData(chartId);
                    return;
                }

                const sthCost = currentData.sth_cost_basis || 0;
                const lthCost = currentData.lth_cost_basis || 0;
                const totalCost = currentData.total_cost_basis || 0;
                const price = currentData.current_price_usd || 0;
                const sthMvrv = currentData.sth_mvrv || 0;
                const lthMvrv = currentData.lth_mvrv || 0;

                // Update info boxes
                MetricsCommon.updateInfoBoxes(infoId, [
                    { title: 'Market Price', value: '$' + price.toLocaleString(), subtitle: 'Current BTC Price' },
                    { title: 'STH Cost Basis', value: '$' + sthCost.toLocaleString(), subtitle: 'MVRV: ' + sthMvrv.toFixed(2) },
                    { title: 'LTH Cost Basis', value: '$' + lthCost.toLocaleString(), subtitle: 'MVRV: ' + lthMvrv.toFixed(2) },
                    { title: 'Realized Price', value: '$' + totalCost.toLocaleString(), subtitle: 'Network Average' }
                ]);

                // Update last-updated timestamp
                document.getElementById('last-updated').textContent =
                    'Updated: ' + MetricsCommon.formatDate(currentData.timestamp || new Date().toISOString());

                // Build bar chart comparing cost bases
                const prices = [price, sthCost, lthCost, totalCost];
                const labels = ['Market Price', 'STH Cost', 'LTH Cost', 'Realized Price'];
                const colors = ['#f7931a', '#ff8844', '#8844ff', '#00ff88'];

                const traces = [{
                    x: labels,
                    y: prices,
                    type: 'bar',
                    marker: {
                        color: colors,
                        line: { color: colors, width: 2 }
                    },
                    text: prices.map(p => '$' + p.toLocaleString()),
                    textposition: 'outside',
                    textfont: { color: '#e0e0e0', size: 12 },
                    hovertemplate: '%{x}: $%{y:,.0f}<extra></extra>'
                }];

                // Add reference line for market price
                const layout = ChartThemes.getLayout('Cost Basis Comparison', 'Price (USD)', {
                    showlegend: false,
                    xaxis: {
                        ...ChartThemes.dark.layout.xaxis,
                        type: 'category',
                        title: ''
                    },
                    yaxis: {
                        ...ChartThemes.dark.layout.yaxis,
                        title: 'Price (USD)',
                        tickformat: '$,.0f'
                    },
                    bargap: 0.3
                });

                // Add horizontal line at market price for comparison
                layout.shapes = [{
                    type: 'line',
                    xref: 'paper',
                    yref: 'y',
                    x0: 0,
                    x1: 1,
                    y0: price,
                    y1: price,
                    line: { color: '#f7931a', width: 2, dash: 'dash' }
                }];

                // Render chart
                MetricsCommon.render(chartId, traces, layout);

            } catch (error) {
                console.error('Error loading Cost Basis data:', error);
                MetricsCommon.showError(chartId, error.message);
            }
        })();
    </script>
</body>
</html>
